name: Deploy to AWS Lightsail

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy:
        description: Deploy to Lightsail (false = build/validate only)
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  packages: write

concurrency:
  group: lightsail-cd-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  build:
    name: Build images (and push when deploying)
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.vars.outputs.should_deploy }}
      should_push: ${{ steps.vars.outputs.should_push }}
      registry_owner: ${{ steps.vars.outputs.registry_owner }}
      web_image: ${{ steps.vars.outputs.web_image }}
      api_image: ${{ steps.vars.outputs.api_image }}
      market_data_image: ${{ steps.vars.outputs.market_data_image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve deploy mode and image tags
        id: vars
        env:
          DISPATCH_DEPLOY: ${{ inputs.deploy }}
        run: |
          set -euo pipefail

          should_deploy=false
          if [[ "$GITHUB_EVENT_NAME" == "push" && "$GITHUB_REF" == "refs/heads/main" ]]; then
            should_deploy=true
          elif [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" && "$DISPATCH_DEPLOY" == "true" ]]; then
            should_deploy=true
          fi

          should_push="$should_deploy"
          image_tag="$GITHUB_SHA"
          registry_owner="$(echo "$GITHUB_REPOSITORY_OWNER" | tr '[:upper:]' '[:lower:]')"
          image_prefix="${REGISTRY}/${registry_owner}"

          web_image="${image_prefix}/wealthtracker-web:${image_tag}"
          api_image="${image_prefix}/wealthtracker-api:${image_tag}"
          market_data_image="${image_prefix}/wealthtracker-market-data:${image_tag}"

          {
            echo "should_deploy=$should_deploy"
            echo "should_push=$should_push"
            echo "registry_owner=$registry_owner"
            echo "web_image=$web_image"
            echo "api_image=$api_image"
            echo "market_data_image=$market_data_image"
          } >> "$GITHUB_OUTPUT"

          echo "Deploy mode: $should_deploy"
          echo "Push images: $should_push"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: steps.vars.outputs.should_push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build web image
        uses: docker/build-push-action@v6
        with:
          context: WealthTrackerClient
          file: WealthTrackerClient/Dockerfile
          push: ${{ steps.vars.outputs.should_push == 'true' }}
          tags: ${{ steps.vars.outputs.web_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build api image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: WealthTrackerServer/Dockerfile
          push: ${{ steps.vars.outputs.should_push == 'true' }}
          tags: ${{ steps.vars.outputs.api_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build market-data image
        uses: docker/build-push-action@v6
        with:
          context: MarketDataService
          file: MarketDataService/Dockerfile
          push: ${{ steps.vars.outputs.should_push == 'true' }}
          tags: ${{ steps.vars.outputs.market_data_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy on Lightsail (2GB / 2vCPU instance)
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.should_deploy == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH
        env:
          LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          LIGHTSAIL_USER: ${{ secrets.LIGHTSAIL_USER }}
          LIGHTSAIL_SSH_PORT: ${{ secrets.LIGHTSAIL_SSH_PORT }}
          LIGHTSAIL_SSH_PRIVATE_KEY: ${{ secrets.LIGHTSAIL_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          : "${LIGHTSAIL_HOST:?Missing LIGHTSAIL_HOST secret}"
          : "${LIGHTSAIL_USER:?Missing LIGHTSAIL_USER secret}"
          : "${LIGHTSAIL_SSH_PRIVATE_KEY:?Missing LIGHTSAIL_SSH_PRIVATE_KEY secret}"

          LIGHTSAIL_SSH_PORT="${LIGHTSAIL_SSH_PORT:-22}"

          mkdir -p ~/.ssh
          printf '%s\n' "$LIGHTSAIL_SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/lightsail.key
          chmod 600 ~/.ssh/lightsail.key
          ssh-keyscan -p "$LIGHTSAIL_SSH_PORT" -H "$LIGHTSAIL_HOST" >> ~/.ssh/known_hosts

      - name: Create deployment env file
        env:
          WEB_IMAGE: ${{ needs.build.outputs.web_image }}
          API_IMAGE: ${{ needs.build.outputs.api_image }}
          MARKET_DATA_IMAGE: ${{ needs.build.outputs.market_data_image }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          NEON_CONNECTION_STRING: ${{ secrets.NEON_CONNECTION_STRING }}
          UPSTASH_REDIS_URL: ${{ secrets.UPSTASH_REDIS_URL }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          JWT_PRIVATE_KEY_PEM: ${{ secrets.JWT_PRIVATE_KEY_PEM }}
          JWT_PUBLIC_KEY_PEM: ${{ secrets.JWT_PUBLIC_KEY_PEM }}
          JWT_ISSUER: ${{ vars.JWT_ISSUER }}
          JWT_AUDIENCE: ${{ vars.JWT_AUDIENCE }}
          JWT_ACCESS_TOKEN_EXP_MINUTES: ${{ vars.JWT_ACCESS_TOKEN_EXP_MINUTES }}
          JWT_REFRESH_TOKEN_EXP_DAYS: ${{ vars.JWT_REFRESH_TOKEN_EXP_DAYS }}
          CACHE_TTL_SECONDS: ${{ vars.CACHE_TTL_SECONDS }}
          CACHE_STALE_TTL_SECONDS: ${{ vars.CACHE_STALE_TTL_SECONDS }}
          SCANNER_REFRESH_SECONDS: ${{ vars.SCANNER_REFRESH_SECONDS }}
          MIGRATE_ON_STARTUP: ${{ vars.MIGRATE_ON_STARTUP }}
          MARKETDATA_TIMEOUT_SECONDS: ${{ vars.MARKETDATA_TIMEOUT_SECONDS }}
          SERVE_STALE_WHILE_REVALIDATE: ${{ vars.SERVE_STALE_WHILE_REVALIDATE }}
          STALE_RETRY_AFTER_MS: ${{ vars.STALE_RETRY_AFTER_MS }}
          YF_RATE_LIMIT_SCREEN_PER_MIN: ${{ vars.YF_RATE_LIMIT_SCREEN_PER_MIN }}
          YF_RATE_LIMIT_DOWNLOAD_PER_MIN: ${{ vars.YF_RATE_LIMIT_DOWNLOAD_PER_MIN }}
          YF_RATE_LIMIT_TICKER_PER_MIN: ${{ vars.YF_RATE_LIMIT_TICKER_PER_MIN }}
          REL_VOL_REUSE_PRIMARY_1M_DOWNLOAD: ${{ vars.REL_VOL_REUSE_PRIMARY_1M_DOWNLOAD }}
        run: |
          set -euo pipefail

          required=(
            FRONTEND_URL
            NEON_CONNECTION_STRING
            UPSTASH_REDIS_URL
            GOOGLE_CLIENT_ID
            GOOGLE_CLIENT_SECRET
            JWT_PRIVATE_KEY_PEM
            JWT_PUBLIC_KEY_PEM
          )

          for key in "${required[@]}"; do
            if [[ -z "${!key:-}" ]]; then
              echo "::error title=Missing required secret::$key is required"
              exit 1
            fi
          done

          JWT_PRIVATE_KEY_PEM="${JWT_PRIVATE_KEY_PEM//$'\r'/}"
          JWT_PRIVATE_KEY_PEM="${JWT_PRIVATE_KEY_PEM//$'\n'/\\n}"
          JWT_PUBLIC_KEY_PEM="${JWT_PUBLIC_KEY_PEM//$'\r'/}"
          JWT_PUBLIC_KEY_PEM="${JWT_PUBLIC_KEY_PEM//$'\n'/\\n}"

          write_kv() {
            printf '%s=%s\n' "$1" "$2" >> lightsail.env
          }

          : > lightsail.env

          write_kv "WEB_IMAGE" "$WEB_IMAGE"
          write_kv "API_IMAGE" "$API_IMAGE"
          write_kv "MARKET_DATA_IMAGE" "$MARKET_DATA_IMAGE"

          write_kv "FRONTEND_URL" "$FRONTEND_URL"
          write_kv "NEON_CONNECTION_STRING" "$NEON_CONNECTION_STRING"
          write_kv "UPSTASH_REDIS_URL" "$UPSTASH_REDIS_URL"
          write_kv "UPSTASH_REDIS_REST_URL" "${UPSTASH_REDIS_REST_URL:-}"
          write_kv "UPSTASH_REDIS_REST_TOKEN" "${UPSTASH_REDIS_REST_TOKEN:-}"

          write_kv "GOOGLE_CLIENT_ID" "$GOOGLE_CLIENT_ID"
          write_kv "GOOGLE_CLIENT_SECRET" "$GOOGLE_CLIENT_SECRET"

          write_kv "JWT_PRIVATE_KEY_PEM" "$JWT_PRIVATE_KEY_PEM"
          write_kv "JWT_PUBLIC_KEY_PEM" "$JWT_PUBLIC_KEY_PEM"
          write_kv "JWT_ISSUER" "${JWT_ISSUER:-WealthTracker}"
          write_kv "JWT_AUDIENCE" "${JWT_AUDIENCE:-WealthTrackerApi}"
          write_kv "JWT_ACCESS_TOKEN_EXP_MINUTES" "${JWT_ACCESS_TOKEN_EXP_MINUTES:-60}"
          write_kv "JWT_REFRESH_TOKEN_EXP_DAYS" "${JWT_REFRESH_TOKEN_EXP_DAYS:-7}"

          write_kv "CACHE_TTL_SECONDS" "${CACHE_TTL_SECONDS:-300}"
          write_kv "CACHE_STALE_TTL_SECONDS" "${CACHE_STALE_TTL_SECONDS:-86400}"
          write_kv "SCANNER_REFRESH_SECONDS" "${SCANNER_REFRESH_SECONDS:-300}"
          write_kv "MIGRATE_ON_STARTUP" "${MIGRATE_ON_STARTUP:-1}"
          write_kv "MARKETDATA_TIMEOUT_SECONDS" "${MARKETDATA_TIMEOUT_SECONDS:-60}"
          write_kv "SERVE_STALE_WHILE_REVALIDATE" "${SERVE_STALE_WHILE_REVALIDATE:-1}"
          write_kv "STALE_RETRY_AFTER_MS" "${STALE_RETRY_AFTER_MS:-15000}"
          write_kv "YF_RATE_LIMIT_SCREEN_PER_MIN" "${YF_RATE_LIMIT_SCREEN_PER_MIN:-6}"
          write_kv "YF_RATE_LIMIT_DOWNLOAD_PER_MIN" "${YF_RATE_LIMIT_DOWNLOAD_PER_MIN:-10}"
          write_kv "YF_RATE_LIMIT_TICKER_PER_MIN" "${YF_RATE_LIMIT_TICKER_PER_MIN:-15}"
          write_kv "REL_VOL_REUSE_PRIMARY_1M_DOWNLOAD" "${REL_VOL_REUSE_PRIMARY_1M_DOWNLOAD:-1}"

      - name: Validate compose rendering
        run: |
          set -euo pipefail
          docker compose \
            --env-file lightsail.env \
            -f deploy/lightsail/docker-compose.lightsail.yml \
            config > /dev/null

      - name: Upload deployment bundle
        env:
          LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          LIGHTSAIL_USER: ${{ secrets.LIGHTSAIL_USER }}
          LIGHTSAIL_SSH_PORT: ${{ secrets.LIGHTSAIL_SSH_PORT }}
        run: |
          set -euo pipefail

          LIGHTSAIL_SSH_PORT="${LIGHTSAIL_SSH_PORT:-22}"
          SSH_TARGET="${LIGHTSAIL_USER}@${LIGHTSAIL_HOST}"

          scp -i ~/.ssh/lightsail.key -P "$LIGHTSAIL_SSH_PORT" \
            deploy/lightsail/docker-compose.lightsail.yml \
            "$SSH_TARGET:/tmp/docker-compose.lightsail.yml"

          scp -i ~/.ssh/lightsail.key -P "$LIGHTSAIL_SSH_PORT" \
            deploy/lightsail/nginx.default.conf.template \
            "$SSH_TARGET:/tmp/nginx.default.conf.template"

          scp -i ~/.ssh/lightsail.key -P "$LIGHTSAIL_SSH_PORT" \
            deploy/lightsail/host-nginx/wealthtrackertrading.com.conf \
            "$SSH_TARGET:/tmp/wealthtrackertrading.com.conf"

          scp -i ~/.ssh/lightsail.key -P "$LIGHTSAIL_SSH_PORT" \
            lightsail.env \
            "$SSH_TARGET:/tmp/lightsail.env"

          ssh -i ~/.ssh/lightsail.key -p "$LIGHTSAIL_SSH_PORT" "$SSH_TARGET" '
            set -euo pipefail
            sudo mkdir -p /opt/wealthtracker
            sudo mkdir -p /opt/wealthtracker/host-nginx
            sudo mv /tmp/docker-compose.lightsail.yml /opt/wealthtracker/docker-compose.lightsail.yml
            sudo mv /tmp/nginx.default.conf.template /opt/wealthtracker/nginx.default.conf.template
            sudo mv /tmp/wealthtrackertrading.com.conf /opt/wealthtracker/host-nginx/wealthtrackertrading.com.conf
            sudo mv /tmp/lightsail.env /opt/wealthtracker/.env
            sudo chown -R $USER:$USER /opt/wealthtracker
          '

      - name: Deploy and restart containers
        env:
          LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          LIGHTSAIL_USER: ${{ secrets.LIGHTSAIL_USER }}
          LIGHTSAIL_SSH_PORT: ${{ secrets.LIGHTSAIL_SSH_PORT }}
          GHCR_USERNAME: ${{ needs.build.outputs.registry_owner }}
          GHCR_READ_TOKEN: ${{ secrets.GHCR_READ_TOKEN }}
        run: |
          set -euo pipefail

          : "${GHCR_READ_TOKEN:?Missing GHCR_READ_TOKEN secret}"

          LIGHTSAIL_SSH_PORT="${LIGHTSAIL_SSH_PORT:-22}"
          SSH_TARGET="${LIGHTSAIL_USER}@${LIGHTSAIL_HOST}"

          printf '%s' "$GHCR_READ_TOKEN" | ssh -i ~/.ssh/lightsail.key -p "$LIGHTSAIL_SSH_PORT" "$SSH_TARGET" "
            set -euo pipefail
            cd /opt/wealthtracker

            if ! command -v docker >/dev/null 2>&1; then
              echo 'docker is not installed on the instance' >&2
              exit 1
            fi

            if ! docker compose version >/dev/null 2>&1; then
              echo 'docker compose plugin is not installed on the instance' >&2
              exit 1
            fi

            docker login ghcr.io -u '$GHCR_USERNAME' --password-stdin
            docker compose --env-file .env -f docker-compose.lightsail.yml pull
            docker compose --env-file .env -f docker-compose.lightsail.yml up -d --remove-orphans
            docker image prune -af --filter 'until=72h'
          "

  cleanup-ghcr:
    name: Cleanup old GHCR image versions
    runs-on: ubuntu-latest
    needs:
      - build
      - deploy
    if: needs.build.outputs.should_push == 'true' && needs.deploy.result == 'success'

    strategy:
      matrix:
        package_name:
          - wealthtracker-web
          - wealthtracker-api
          - wealthtracker-market-data

    steps:
      - name: Delete old versions
        uses: actions/delete-package-versions@v5
        with:
          owner: ${{ needs.build.outputs.registry_owner }}
          package-name: ${{ matrix.package_name }}
          package-type: container
          min-versions-to-keep: 5
          token: ${{ secrets.GITHUB_TOKEN }}

  verify:
    name: Final verification
    runs-on: ubuntu-latest
    needs:
      - build
      - deploy
      - cleanup-ghcr
    if: needs.build.outputs.should_deploy == 'true' && needs.deploy.result == 'success' && needs['cleanup-ghcr'].result == 'success'

    steps:
      - name: Configure SSH
        env:
          LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          LIGHTSAIL_USER: ${{ secrets.LIGHTSAIL_USER }}
          LIGHTSAIL_SSH_PORT: ${{ secrets.LIGHTSAIL_SSH_PORT }}
          LIGHTSAIL_SSH_PRIVATE_KEY: ${{ secrets.LIGHTSAIL_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          : "${LIGHTSAIL_HOST:?Missing LIGHTSAIL_HOST secret}"
          : "${LIGHTSAIL_USER:?Missing LIGHTSAIL_USER secret}"
          : "${LIGHTSAIL_SSH_PRIVATE_KEY:?Missing LIGHTSAIL_SSH_PRIVATE_KEY secret}"

          LIGHTSAIL_SSH_PORT="${LIGHTSAIL_SSH_PORT:-22}"

          mkdir -p ~/.ssh
          printf '%s\n' "$LIGHTSAIL_SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/lightsail.key
          chmod 600 ~/.ssh/lightsail.key
          ssh-keyscan -p "$LIGHTSAIL_SSH_PORT" -H "$LIGHTSAIL_HOST" >> ~/.ssh/known_hosts

      - name: Verify deployment
        env:
          LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          LIGHTSAIL_USER: ${{ secrets.LIGHTSAIL_USER }}
          LIGHTSAIL_SSH_PORT: ${{ secrets.LIGHTSAIL_SSH_PORT }}
        run: |
          set -euo pipefail

          LIGHTSAIL_SSH_PORT="${LIGHTSAIL_SSH_PORT:-22}"
          SSH_TARGET="${LIGHTSAIL_USER}@${LIGHTSAIL_HOST}"

          ssh -i ~/.ssh/lightsail.key -p "$LIGHTSAIL_SSH_PORT" "$SSH_TARGET" 'bash -s' <<'REMOTE'
          set -euo pipefail

          web_code=$(curl -sS -o /dev/null -w '%{http_code}' http://127.0.0.1:8080/)
          if [[ "$web_code" != "200" ]]; then
            echo "Web check failed with HTTP $web_code" >&2
            exit 1
          fi

          api_code=$(curl -sS -o /dev/null -w '%{http_code}' http://127.0.0.1:8080/api/)
          if [[ "$api_code" != "401" && "$api_code" != "404" ]]; then
            echo "API gateway check failed with HTTP $api_code" >&2
            exit 1
          fi

          cd /opt/wealthtracker
          docker compose --env-file .env -f docker-compose.lightsail.yml ps
          REMOTE
